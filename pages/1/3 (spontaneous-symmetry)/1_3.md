---
l1idx: 1
l2idx: 3
title: "Symmetric paths through stateful services"
permalink: 1_3.html
summary: "A routing-policy framework to enable distributed/stretched network security zones across multiple sites, with stateful inspection services applied once-only to inter-zone traffic"
---

Enterprises with multiple network security zones spread across multiple locations and gated by stateful-inspection/perimeter services face several challenges related to optimization.

The desired/optimal behavior is:
  - Traffic will *not* traverse any stateful perimeter services if the source and destination are in the same security zone
    - Those services have finite capacity, which we don't want to spend inspecting traffic that doesn't *need* to be inspected
  - Traffic *will* traverse perimeter services if the source and destination are in separate security zones
    - This is inherent to the concept of a network security zone.
  - Traffic won't traverse *multiple* instances of the same perimeter services on the same security-zone's perimeter
    - Again, resources are finit.
  - Traffic with source and destination at the same site will not take a hairpin/trombone path through a separate site
  - Routing-policy configuration remains managable


Historically, "sacrifices were made", with regards to achieving some of these objectives at the expense of others.  This article provides an abbreviated case study of how those compromises evolved over time at one enterprise and then provides a novel route-policy framework that eliminates the need for compromise.

This novel framework has three main elements:
  - An analysis of the desired path-selection behavior relying exclusively on the following properties:
    - A numeric value uniquely identifying the "site" at which the prefix was originated
    - A number value uniquely identify the "security-zone" in which the prefix was originated
    - The number of stateful-services hops that the prefix has been propagated through *at the site-of-origin*
    - Numeric values uniquely identifying the "site" and "security-zone" of the router forwarding the packets
  - An encoding schema for the properties above using BGP large-community attributes
  - Algorithmic formalization of the desired behavior
    - In flow-chart format
      - Mapped to corresponding device configuration elements (route-maps, prefix-lists, etc...)

GNS3 virtual-lab topologies (using pre-configured Arista cEOS containers) demonstrating both the proof-of-problem topology and the proof-of-solution topology are provided to help illustrate these concepts.
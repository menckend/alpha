---
l1idx: 1
l2idx: 3
l3idx: 2
l4idx: 2
l5idx: 1
title: "Design Enumeration"
permalink: 1_3_2_2_1.html
summary: "Like a jigsaw puzzle with eight different right answers"
---

A primary focus of our analsysis will be whether an effective/managable policy framework for symmetric pathing is viable for all, some, or none of the designs/topologies we have contemplated up to this point.  In this page, we will formalize those design options and enumerate the expected BGP RIF/FIB behavior for each.

## Design options

Our analysis will consider multiple permutations of the following design-options/patterns:

### Pattern 1

This option utilizes per site / per-workload-zone firewall instances and has the following elements:

- Workload-zone VRFs and transit-zone VRFs are instantiated on each site's network infrastructure and are extended between sites
  - Transit-zone is extended to *all* sites
  - Workload-zones are only extended to sites if hosted-work is present at that site/zone
- A firewall is instantiated when a specific workload-hosting zone has workload present at a specific site
- Each FW has one interface in a site's transit-zone and one in a workload-hosting zone at the same site
- Each firewall has a unique BGP AS and is an eBGP peer with the site's transit VRF and the site's workload-VRF (of the zone it is "attached" to)
- All inter-zone routing within a site is performed by the site's L3-network infrastructure's transit-zone VRF 

{% capture details %}{% include drawio-embed-addSVG.html drawiolink='./pages/1/3(ecmp-symmetric)/framework-algo-2-a.drawio.svg' drawiozoom='1.25' %}{% endcapture %}{% capture summary %}Show/hide diagram{% endcapture %}{% include details.html %}

> This pattern is topologically identical to a similar pattern in which monolithic firewalls are implemented, but are configured with per-workload-zone VRFs (with unique ASNs) and with no internal transit-VRF or route-leaking between them.  The result is Layer-3 isolated, per-zone paths through the firewalls.

### Option 2

This option utilizes per-site (monolithic) firewall instances with a single routing function and has the following elements:

- Workload-zone VRFs are instantiated on each site's network infrastructure and are extended between sites
- The transit-zone VRF is implemented on the WAN-site only and extended directly to a transit-zone interface on each site's firewall
- FWs have interfaces on the "transit zone" (peered directly to the WAN VRF)
- FWs have interfaces in multiple "workload-hosting zones" (instantiated as isolated VRFs in the site's network infrastructure)
- An interface in a specific workload-hosting zone is instantiated on the firewall *only* if workload is present/hosted in that zone at that site
- The firewall routes traffic between its interfaces, acting as a single BPG AS.

{% capture details %}{% include drawio-embed-addSVG.html drawiolink='./pages/1/3(ecmp-symmetric)/framework-algo-2-b.drawio.svg' drawiozoom='1.25' %}{% endcapture %}{% capture summary %}Show/hide diagram{% endcapture %}{% include details.html %}

### Option 3

This option also utilizes per-site/monolithic firewall instances, but internally implements per-zone VRFs.  The following design elements are present
- Workload-zone VRFs are instantiated on each site's network infrastructure and are extended between sites
- The transit-zone VRF is implemented on the WAN-site only and extended directly to a transit-zone interface on each site's firewall
- FWs have interfaces on the "transit zone" (peered directly to the WAN VRF)
- FWs have interfaces, VRFs, and BGP ASNs in multiple "workload-hosting zones"
  - eBGP peering is configured between each VRF on the monolithic firewalls.

{% capture details %}{% include drawio-embed-addSVG.html drawiolink='./pages/1/3(ecmp-symmetric)/framework-algo-2-c.drawio.svg' drawiozoom='1.25' %}{% endcapture %}{% capture summary %}Show/hide diagram{% endcapture %}{% include details.html %}

## Amalgamated Topology

We will base the remainder of our analysis on the reference topology below, which implements *each* of the three design options from the previous section at two sites. Doing this allows us to account for the nuances of traffic *between endpoints hosted in different design options/topologies*.

{% capture details %}{% include drawio-embed-addSVG.html drawiolink='./pages/1/3(ecmp-symmetric)/framework-algo-2-d.drawio.svg' drawiozoom='1.25' %}{% endcapture %}{% capture summary %}Show/hide diagram{% endcapture %}{% include details.html %}

> The following pattern was used in assigning AS numbers (purely for ease of reference):  
>  - Digit-1 signifies the BGP speaker's "device type" 
>   - "1" = standard router with no stateful inspection services; 
>   - "2" = firewall or other stateful insepction/enforcement device)
> - Digit-2 signifies the site in which the BGP speaker is located
> - Digit 3 signifies the (workload-hosting)"zone" in which the BGP speaker is connected
> - Digit-4 signifies the index/instance-number of device-type in the same zone and site. 

### Flows of interest

We will document the expected BGP routes for the following pairs of endpoints in the amalagamated topology above (assuming eBGP peering with no policy configured to modify default behavior)in order to ensure that our framework accounts for flows between endpoints residing in different desing-option topologies.  (The two endpoints are notated here with the identifying information of the workload-zone VRF to which actual workload is attached.)

{% capture details %}

- Endpoints
  - site-1/zone-3 (s1-z3, ASN1131)
  - site-2/zone-4 (s2-z4, ASN1241)
- Equal cost paths
  - 3 paths (A, B, C)
  - Each path consists of seven nodes (6, with starting-node excluded)

{% include drawio-embed-addSVG.html drawiolink='./pages/1/3(ecmp-symmetric)/framework-algo-2-e.drawio.svg' drawiozoom='1.25' %}


{% endcapture %}{% capture summary %}
Case 1
{% endcapture %}{% include details.html %}


- Case 1 (Option-1 : Option-1 endpoints)
  - site-1/zone-3 (s1-z3, ASN1131)
  - site-2/zone-4 (s2-z4, ASN1241)
- Case 2 (Option-1 : Option-2 endpoints)
  - site-1/zone-3 (s1-z3, ASN1131)
  - site-2/zone-1 (s2-z1, ASN1211)
- Case 3 (Option-1 : Option-3 endpoints)
  - site-1/zone-3 (s1-z3, ASN1131)
  - site-2/zone-5 (s2-z5, ASN1251)
- Case 4 (Option-2 : Option-2 endpoints)
  - site-1/zone-1 (s1-z1, ASN1111)
  - site-2/zone-2 (s2-z2, ASN1221)
- Case 5 (Option-2 : Option-3 endpoints)
  - site-1/zone-1 (s1-z1, ASN1111)
  - site-2/zone-5 (s2-z5, ASN1251)  
- Case 6 (Option-3 : Option-3 endpoints)
  - site-1/zone-5 (s1-z5, ASN1251)  
  - site-2/zone-6 (s2-z6, ASN1251)  

The following diagram depicts the amalgamated topology with the equal-costs paths between endpoints for each of the previous cases illustrated:



{% capture details %}{% include drawio-embed-addSVG.html drawiolink='./pages/1/3(ecmp-symmetric)/framework-algo-2-e.drawio.svg' drawiozoom='1.25' %}{% endcapture %}{% capture summary %}Show/hide diagram{% endcapture %}{% include details.html %}





###### Leftovers; re-integrate this text later
We will consider topologies with permutations of the following design elements:
- Firewall instantiation/rules-of-inference
  - A single (HA pair or cluster) monolithic/multi-zone firewall per-site pattern
  - A single (HA pair or cluster) firewall per-site/per-zone pattern
- Inter-zone routing pattern
  - The (monolithic) firewall routes traffic directly between zones with*out* a BGP "hop" along the way  (single-VRF firewall)
  - The (monolithic) firewall routes traffic directly between zones *with* a BGP "hop" along the way (multi-VRF/internal-transit-zone firewall)
  - The firewall *only* routes traffic between the transit-zone and attached workload-zone.


In the first, firewalls are instantiated per-zone, and traffic between zones is routed on an explicitly instantiated transit-zone routing function.

{% capture details %}
{% include drawio-embed-addSVG.html drawiolink='./pages/1/3(ecmp-symmetric)/framework-algorithm-1-a.drawio.svg' drawiozoom='1.25' %}
{% endcapture %}
{% capture summary %}Show/hide diagram{% endcapture %}{% include details.html %}

In the preceding diagram, two workload-hosting network security zones have been deployed at each of two sites.  Each of those zones is extended between sites across the WAN.  In addition, a "transit zone" has been extended across the WAN between the two sites.

The three best (and equal cost) paths between site-1/zone-2 and site-2/zone-3 are illustrated above, and the AS-path of each of those paths is listed in the boxes at the bottom.

In the second topology, monolithic multizone per-site firewalls are deployed and are capable of routing traffic directly between zones 

{% capture details %}
{% include drawio-embed-addSVG.html drawiolink='./pages/1/3(ecmp-symmetric)/framework-algorithm-1-b.drawio.svg' drawiozoom='1.25' %}
{% endcapture %}
{% capture summary %}Show/hide diagram{% endcapture %}{% include details.html %}


## Initial Analysis

In the first  topology, inter-site/inter-zone flows traverse three equal-cost paths in both ("A-to-B" and "B-to-A") directions.
- Path "A" traverses the zone-2 FW and zone-3 FW in site-2  (and no firewalls in site-1)
- Path "B" traverses the zone-2 FW and zone-3 FW in site-1  (and no firewalls in site-2)
- Path "C" traverses the zone-2 FW in site-1 and the zone-3 F in site-2

Paths A and B both traverse firewalls at one site only, while path C traverses firewalls at both sites 1 and 2.  From an optimization perspective, path C is marginally preferable to paths A and B because it splits the firewall capacity consumption across the two sites.

In the second topology, there are only two equal-cost paths.  Path A traverses the site-1 firewall and path b traverses the site 2 firewall.  From an optimizaiton perspective, nothing recommends one path over the other.


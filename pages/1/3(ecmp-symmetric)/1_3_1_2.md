---
l1idx: 1
l2idx: 3
l3idx: 1
l4idx: 2
title: "Second Design Iteration"
permalink: 1_3_1_2.html
summary: "Inter-site connectivity is added for the additional security zones.  Routing must be explicitly manipulated to maintain the de-facto transit-zone for all any inter-site+inter-zone traffic. "
---

## Graphical Depiction  
This design iteration is depicted in the following diagram

{% include drawio-embed-addSVG.html drawiolink='./pages/1/3(ecmp-symmetric)/casestudy-2a.drawio.svg' drawiozoom='1.5' %}


## Design elements

As illustrated above, the second design iteration modifies the initial design iteration with the following additions
    - Inter-data-center connectivity is provisioned for zones 2 and 3
      - Supplementing the existing IDC for zone 1
    - This enables desired behavior for all int*ra*-zone/int*er*-site flows
      - These no longer traverse *any* firewalls
        - they traversed both site1 and site2 firewalls in the previous design
    - This also *breaks* previously working behavior for int*er*-zone/in*er*-site flows.
      - Each site/zone VRF learns two equal-cost routes to each of the other two zones at the remote site.
        - Resulting in a high percentage of flows being routed asymmetrically, through different firewalls
      - BGP policy is implemented to suppress the asymmetry

### BGP policy design

The following figure illustrates how each zone's VRF in one site learns 3 paths to a different zone at the other site, two of which have equal as-path-lenthgs.  Those two equal-cost paths are the cause of the routing asymmetry discussed above.  The third (high-cost) path was used to resolve the asymmetry.

{% include drawio-embed-addSVG.html drawiolink='./pages/1/3(ecmp-symmetric)/casestudy-2a.drawio.svg' drawiozoom='1.5' %}


Multiple BGP-based strategies are available to eliminate equal-cost paths and resulting asymmetric flows, but before one can be designed, the desired forwarding behavior has to be established.  In this case, the question to answer was:

> When a flow is between endpoints that reside in separate security-zones in different sites, *which* site's firewall should the flow traverse?
 - "Always choose the site-1 (or site-2) FW path" would result in *all* inspection for these flows being handled on one site's firewalls
   - Frustrating the design objective of equal workload distribution across the two sites
   - And creating significant risk of configuration drift between the firewalls at the two sites.
     - The non-preferred site's firewall only handles these flows during a failure of the primary site's firewalls.
 - "Choose a preferred firewall for each destination zone" wasn't tenable
   - "Destination" isn't a property of a reflexive flow (A->B *and* B->A); it's a property of an individual packet
     - "There" and "back" packets in a given flow are going to have inverted destination zones
 - "Both" was the unwanted compromise
   - Zone 1 remained the "transit zone", providing inter-data-center transport for  *all* of the inter-zone/inter-site flows.  (Even the ones that didn't have an endpoint in zone-1)
   - Route-maps and IP prefix-lists were maintained to enforce the following logic on each zone's VRF:
     - When learning a route to a prefix that is in another site, prefer the route that includes the zone1 VRF's AS#.
       - Each VRF was configured to assign a higher-than-default local preference to any routes:
         - That matched a list of "the other site's networks"
         - That included the local site's zone-1 VRF in the AS-path.




## Gaps / Limitations

This design iteration was sub-optimal in the following regards:

  - Security-zone "1" still functions as a de-facto "transit zone" for all inter-site/inter-zone traffic
    - We don't want traffic between zones 2 and 3 routed across zone 1.
    - We don't want zone 1's firewall rule configuration to include traffic that is not to or from zone 1
  - Route-policy configuration overhead increases quickly as the number of sites and zones is increased
    - Route-map configuration is inconsistent across zones
      - The preferred path for every zone-ID/site-ID pair is selected arbitrarily during network design, and is enforced with a combination of local-preference and MED metrics
        - There is no "rule" to describe this configuration; every additional site/zone tuple requires an additional manual iteration of this policy
    - Multiple IP prefix-lists must be duplicated across multiple routers



- Firewall instances are conceptualized as per-zone entities with a firewall-cluster-local transit path between zones
    - This reflects the internal architecture of the firewall platform in use
    - It is also critical to subsequent design iterations

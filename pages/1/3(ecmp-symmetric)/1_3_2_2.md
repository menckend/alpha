---
l1idx: 1
l2idx: 3
l3idx: 2
l4idx: 2
title: "The Algorithm"
permalink: 1_3_2_2.html
summary: "Mirrors!"
---

In this section, we will extrapolate a path-selection algorithm that addresses the previously discussed challenge of unpredictably asymmetric paths for flows with endpoints in different security zones and sites from each other.  As previously discussed, the generalized problem statement is:

>For every packet traversing both a security zone border and a site border, there will be ECMP routes present for the destination at both the originating-VRF of the packet and at the zone-0 VRF of the site at which the packet originated.  This will result in asymmetric pathing that causes packets in the same flow to traverse different firewall instances, which will cause the firewalls to drop the packets as out-of-state.

We will use two distinct topologies as a starting point for our analaysis:

In the first, firewalls are instantiated per-zone, and traffic between zones is routed on an explicitly instantiated transit-zone routing function.

{% capture details %}
{% include drawio-embed-addSVG.html drawiolink='./pages/1/3(ecmp-symmetric)/framework-algorithm-1-a.drawio.svg' drawiozoom='.75' %}
{% endcapture %}
{% capture summary %}Show/hide diagram{% endcapture %}{% include details.html %}

In the preceding diagram, two workload-hosting network security zones have been deployed at each of two sites.  Each of those zones is extended between sites across the WAN.  In addition, a "transit zone" has been extended across the WAN between the two sites.

The three best (and equal cost) paths between site-1/zone-2 and site-2/zone-3 are illustrated above, and the AS-path of each of those paths is listed in the boxes at the bottom.


In the second topology, monolithic multizone per-site firewalls are deployed and are capable of routing traffic directly between zones 

{% capture details %}
{% include drawio-embed-addSVG.html drawiolink='./pages/1/3(ecmp-symmetric)/framework-algorithm-1-b.drawio.svg' drawiozoom='.75' %}
{% endcapture %}
{% capture summary %}Show/hide diagram{% endcapture %}{% include details.html %}


## Initial Analysis

In the first  topology, inter-site/inter-zone flows traverse three equal-cost paths in both ("A-to-B" and "B-to-A") directions.
- Path "A" traverses the zone-2 FW and zone-3 FW in site-2  (and no firewalls in site-1)
- Path "B" traverses the zone-2 FW and zone-3 FW in site-1  (and no firewalls in site-2)
- Path "C" traverses the zone-2 FW in site-1 and the zone-3 F in site-2

Paths A and B both traverse firewalls at one site only, while path C traverses firewalls at both sites 1 and 2.  From an optimization perspective, path C is marginally preferable to paths A and B because it splits the firewall capacity consumption across the two sites.

In the second topology, there are only two equal-cost paths.  Path A traverses the site-1 firewall and path b traverses the site 2 firewall.  From an optimizaiton perspective, nothing recommends one path over the other.

A primary focus of our analsysis will be wether a effective/managable policy framework for symmetric pathing is viable for either, or both of these topologies (and for a blended topology with additional security zones deployed in a combination of per-zone and multi-zone instances.)

## Path Characterization

In order for flows to succeed they must traverse the same *stateful* hops in each direction.  If we are to solve this using routing policy, we'll need to describe the potential paths in terms of those stateful hops.

And, because we're concerned with symmetry, we'll need to find a way of parsing those descriptions that creates the same results when evaluated "forwards" and "backwards."  Given that a flow consists of packets moving in both direcitons between two endpoints (A and B). Our algorithm will need to yield paths with the same stateful hops for both the A->B and B->A directions.  

We can *characterize* those paths based on the following properties:
- Source properties
  - The security-zone-ID (as a numeric value) in which the packet's source is located
  - The site-ID (as a numeric value) in which the packet's source is located
  - The number of stateful-hops in the packet's destination-site
- Destination properties
  - The security-zone-ID in which the packet's destination is located
  - The site-ID in which the packet's destination is located
  - The number of stateful-hops in the packet's destination-site
- Whether the path traverses the transit-zone in site-0 (the WAN.)

That group of properties *is* sufficient for us to construct path-selection rules that yield a symmetric path.  Consider the following.
- We can classify any packet as "low-to-high" or "high-to-low" with regards to both security-zone-ID and site-ID.
  - Having assigned a (n arbitrary) numerical index to each security-zone and each site
  - In a given flow, if A->B is "low-to-high", we know that B->A will be "high-to-low"
    - That is, a comparison will yield "opposite" results for A->B and B->A directions of a given flow
- The topology that we have dictated ensures that for any inter-site/inter-zone flow, the available equal-cost paths will have the following distribution of stateful hops
  - Both firewalls in the "A" side (call it "path-1")
  - Both firewalls in the "B" side (call it "path-2")
  - One firewall in both the "A" side and the "B" side (call it "path-3")

We established previously that we prefer to *not* have a flow traverse firewalls at both sites, which leaves us in need of a decision procedure that will select either path-1 or path-2 when executed on *both* the A->B and B->A directions of a flow.

There are *two* key insights that we can combine to achieve this objective:

> The question "is the source or destination-zone 'higher'" will always have the opposite answers for "A->B" and "B->A" packets.

> "The path with more stateful hops in the *destination* site" for "A->B" packets will always be the same as "the path with more stateful hops in the *source" site" for "B->A" packets

With those two givens, the basics of our policy for modifying eBGP path selection in the case of ECMPs emerges:

> On routers with non-zero site-IDs (physical sites; not the WAN) and zero security-zone IDs (the transit zone) always prefer next-hops with a non-zero zone ID to next-hops with a zone-ID of zero.

> Always prefer the path with more stateful hops in the site of the higher security zone.

